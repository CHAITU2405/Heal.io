{% extends "layout.html" %}

{% block page_title %}Patient: {{ patient.first_name }} {{ patient.last_name }}{% endblock %}
{% block page_subtitle %}Detailed vitals and health data for this patient.{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <a href="{{ url_for('doctor_patients') }}" class="btn-bespoke btn-bespoke-outline">
        <span class="material-icons-round">arrow_back</span> Back to Patients
    </a>
</div>

<!-- Patient Profile -->
<div class="panel-bespoke">
    <div style="display: flex; align-items: center; gap: 1.5rem;">
        <div style="width: 64px; height: 64px; border-radius: 50%; background: var(--primary); display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 1.25rem; color: white;">
            {{ patient.first_name[0] }}{{ patient.last_name[0] }}
        </div>
        <div style="flex: 1;">
            <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 0.5rem;">{{ patient.first_name }} {{ patient.last_name }}</h3>
            <div class="mono" style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem;">Patient ID: #{{ patient.id }}</div>
            {% if patient.is_non_verbal %}
            <span class="badge-bespoke badge-bespoke-warning">Non-Verbal Patient</span>
            {% endif %}
            {% if patient.phone %}
            <div class="mono" style="font-size: 0.7rem; color: var(--text-muted); margin-top: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                <span class="material-icons-round" style="font-size: 0.9rem;">phone</span> {{ patient.phone }}
            </div>
            {% endif %}
            {% if patient.emergency_contact_name %}
            <div class="mono" style="font-size: 0.7rem; color: var(--text-muted); margin-top: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                <span class="material-icons-round" style="font-size: 0.9rem; color: var(--danger);">emergency</span> 
                Emergency: {{ patient.emergency_contact_name }}
                {% if patient.emergency_contact_phone %} - {{ patient.emergency_contact_phone }}{% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

{% if current_vital %}
<div class="panel-bespoke">
    <h3 style="font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-secondary); margin-bottom: 1.5rem;">
        Current Vitals
    </h3>
    <div class="responsive-grid responsive-grid-auto">
        {% if current_vital.heart_rate %}
        <div class="stat-card">
            <div class="icon-box red">
                <span class="material-icons-round">favorite</span>
            </div>
            <div class="stat-info">
                <h3>Heart Rate</h3>
                <p>{{ "%.0f"|format(current_vital.heart_rate) }} <span>BPM</span></p>
            </div>
        </div>
        {% endif %}
        {% if current_vital.oxygen_saturation %}
        <div class="stat-card">
            <div class="icon-box blue">
                <span class="material-icons-round">water_drop</span>
            </div>
            <div class="stat-info">
                <h3>Oxygen Saturation</h3>
                <p>{{ "%.0f"|format(current_vital.oxygen_saturation) }} <span>%</span></p>
            </div>
        </div>
        {% endif %}
        {% if current_vital.body_temperature %}
        <div class="stat-card">
            <div class="icon-box purple">
                <span class="material-icons-round">device_thermostat</span>
            </div>
            <div class="stat-info">
                <h3>Temperature</h3>
                <p>{{ "%.1f"|format(current_vital.body_temperature) }} <span>°F</span></p>
            </div>
        </div>
        {% endif %}
        {% if current_vital.blood_pressure_systolic or current_vital.blood_pressure_diastolic %}
        <div class="stat-card">
            <div class="icon-box yellow">
                <span class="material-icons-round">monitor_heart</span>
            </div>
            <div class="stat-info">
                <h3>Blood Pressure</h3>
                <p>{{ "%.0f"|format(current_vital.blood_pressure_systolic) if current_vital.blood_pressure_systolic else '--' }}/{{ "%.0f"|format(current_vital.blood_pressure_diastolic) if current_vital.blood_pressure_diastolic else '--' }} <span>mmHg</span></p>
            </div>
        </div>
        {% endif %}
        {% if current_vital.respiratory_rate %}
        <div class="stat-card">
            <div class="icon-box green">
                <span class="material-icons-round">air</span>
            </div>
            <div class="stat-info">
                <h3>Respiratory Rate</h3>
                <p>{{ "%.0f"|format(current_vital.respiratory_rate) }} <span>br/m</span></p>
            </div>
        </div>
        {% endif %}
    </div>
    <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(16, 185, 129, 0.1); border-left: 2px solid var(--success); border-radius: var(--radius-sm);">
        <div class="mono" style="font-size: 0.75rem; color: var(--success); font-weight: 700;">
            LAST UPDATED: {{ current_vital.recorded_at.strftime('%b %d, %Y')|upper }} • {{ current_vital.recorded_at.strftime('%H:%M') }} UTC
        </div>
    </div>
</div>
{% endif %}

{% if vitals_data.dates %}
<div class="panel-bespoke">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h3 style="font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-secondary);">
            Vitals Trend (Last 30 Readings)
        </h3>
        <select id="vitalType" class="input-bespoke" style="width: auto; padding: 0.5rem 1rem; font-size: 0.8rem;">
            <option value="heart_rate">Heart Rate</option>
            <option value="oxygen_saturation">Oxygen Saturation</option>
            <option value="blood_pressure_systolic">Blood Pressure Systolic</option>
            <option value="blood_pressure_diastolic">Blood Pressure Diastolic</option>
            <option value="respiratory_rate">Respiratory Rate</option>
            <option value="temperature">Temperature</option>
            <option value="steps">Steps</option>
            <option value="sleep_hours">Sleep Hours</option>
        </select>
    </div>
    <div style="height: 400px;">
        <canvas id="vitalsChart"></canvas>
    </div>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    {% if vitals_data.dates %}
    const vitalsData = {{ vitals_data|tojson }};
    let currentChart = null;
    
    function updateChart(type) {
        const ctx = document.getElementById('vitalsChart').getContext('2d');
        
        if (currentChart) {
            currentChart.destroy();
        }
        
        const labels = vitalsData.dates;
        let data = [];
        let label = '';
        let color = '#3b82f6';
        
        switch(type) {
            case 'heart_rate':
                data = vitalsData.heart_rate;
                label = 'Heart Rate (bpm)';
                color = '#ef4444';
                break;
            case 'oxygen_saturation':
                data = vitalsData.oxygen_saturation;
                label = 'Oxygen Saturation (%)';
                color = '#3b82f6';
                break;
            case 'blood_pressure_systolic':
                data = vitalsData.blood_pressure_systolic;
                label = 'Blood Pressure Systolic (mmHg)';
                color = '#8b5cf6';
                break;
            case 'blood_pressure_diastolic':
                data = vitalsData.blood_pressure_diastolic;
                label = 'Blood Pressure Diastolic (mmHg)';
                color = '#a855f7';
                break;
            case 'respiratory_rate':
                data = vitalsData.respiratory_rate;
                label = 'Respiratory Rate (br/m)';
                color = '#10b981';
                break;
            case 'temperature':
                data = vitalsData.temperature;
                label = 'Temperature (°F)';
                color = '#f59e0b';
                break;
            case 'steps':
                data = vitalsData.steps;
                label = 'Steps';
                color = '#6366f1';
                break;
            case 'sleep_hours':
                data = vitalsData.sleep_hours;
                label = 'Sleep Hours';
                color = '#8b5cf6';
                break;
        }
        
        const grad = ctx.createLinearGradient(0, 0, 0, 400);
        // Convert hex to rgba
        const hexToRgba = (hex, alpha) => {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        };
        grad.addColorStop(0, hexToRgba(color, 0.3));
        grad.addColorStop(1, hexToRgba(color, 0));
        
        currentChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: label,
                    data: data,
                    borderColor: color,
                    backgroundColor: grad,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        labels: {
                            color: '#94a3b8',
                            font: { family: 'Inter', size: 12 }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { color: 'rgba(255,255,255,0.05)' },
                        ticks: { color: '#64748b', font: { family: 'IBM Plex Mono', size: 10 } }
                    },
                    y: {
                        grid: { color: 'rgba(255,255,255,0.05)' },
                        ticks: { color: '#64748b', font: { family: 'IBM Plex Mono', size: 10 } },
                        beginAtZero: false
                    }
                }
            }
        });
    }
    
    document.getElementById('vitalType').addEventListener('change', function(e) {
        updateChart(e.target.value);
    });
    
    updateChart('heart_rate');
    {% endif %}
</script>
{% endblock %}
